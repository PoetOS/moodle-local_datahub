define(["jquery","jqueryui","core/templates","core/notification"],function(a,b,c,d){function e(){if(window.Intl&&"object"==typeof window.Intl){var b=Intl.DateTimeFormat().resolvedOptions().timeZone;b&&(ca=M.util.get_string("queuetimezone","local_datahub",b))}a("#timezone_alert p").text(ca)}function f(a){return("0"+String(a)).slice(-2)}function g(b){a(".local_datahub_"+b+" #loading_indicator").addClass("loading")}function h(b){a(".local_datahub_"+b+" #loading_indicator").removeClass("loading")}function i(a){a.find(".reschedule-indicator").addClass("loading")}function j(a){a.find(".reschedule-indicator").removeClass("loading")}function k(){a("#pausecontinue_parent .processing-indicator").addClass("loading")}function l(){a("#pausecontinue_parent .processing-indicator").removeClass("loading")}function m(b,c,d){d||(d=a(".local_datahub_queue")),d.find(".queue_"+b+"_msg").html(c);var e=d.find(".queue_"+b);e.hasClass("show")?(e.removeClass("show"),setTimeout(function(){e.addClass("show")},400)):e.addClass("show"),setTimeout(function(){e.hasClass("show")&&e.removeClass("show")},3e4)}function n(){function b(a,b){return window.getComputedStyle(a,null).getPropertyValue(b)}var c=document.createElement("span");if(c.className="fa",c.style.display="none",document.body.insertBefore(c,document.body.firstChild),"FontAwesome"!==b(c,"font-family")){var d='<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">';a("head").children("script, link").last().after(d)}document.body.removeChild(c)}function o(a){var b=r(),c=a.find("input.reschedule_task").val(),d=Date.parse(c),e=new Date(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate(),d.getUTCHours(),d.getUTCMinutes(),d.getUTCSeconds());return b>=d||isNaN(d)?!1:Date.parse(e)/1e3}function p(){var b=a('#queue_job_table .job-reschedule-row input[type="radio"]');b.change(function(b){var c=a(b.currentTarget).parents("form").find(".queue_date_select input");a(b.currentTarget).is(":checked")&&"schedule"==a(b.currentTarget).val()?c.prop("disabled",!1):c.prop("disabled",!0)})}function q(){a(".queue_alert button.close, .queue_success button.close").on("click",function(b){b.stopPropagation(),a(b.currentTarget).parents(".alert").removeClass("show")})}function r(){var a=Date.now();return new Date(a)}function s(a){var b=Date.now(),c=new Date(b),d=c.getFullYear()+"-"+f(c.getMonth()+1)+"-"+f(c.getDate());return a&&(d+="T"+f(c.getHours()+1)+":"+f(c.getMinutes())),d}function t(a){var b=Date.now(),c=new Date(b);return"min"==a?c.getFullYear()+"-"+f(c.getMonth()+1)+"-"+f(c.getDate())+"T00:00":c.getFullYear()+5+"-"+f(c.getMonth()+1)+"-"+f(c.getDate())+"T00:00"}function u(){var b=t("max"),c=t("min");a("input.reschedule_task").attr("max",b),a("input.reschedule_task").attr("min",c),a("input.reschedule_task").attr("value",s(!0))}function v(b,e){if(Y.log("renderjobsqueue"),b.data.length<=0){var f={type:"queue"};c.render("local_datahub/nojobs",f).done(function(b){e.remove(),a(".table.jobs .insert-inside").html(b),I(),p(),H(),m("alert",da)}).fail(d.exception)}else c.render("local_datahub/queuejobs",b).done(function(b){e.remove(),a(".table.jobs .insert-inside").html(b),I(),p(),H(),u()}).fail(d.exception)}function w(){Y.log("refresh_jobs");var b=a(".table.jobs .job-row, .table.jobs .job-reschedule-row");b.length>=1&&b.hide(),g("queue"),a.ajax({method:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=getqueuelist&sesskey="+U,dataType:"json",timeout:3e4,data:{},error:function(a,c,d){h("queue"),m("alert",ea),b.show()},success:function(a){var c={};c=a,console.log("refresh jobs success, logging object"),console.log(c),c&&c.success===!0?(h("queue"),v(c,b)):(h("queue"),b.show(),m("alert",ea))}})}function x(){W=[];var b=a('#queue_job_table tr[data-type="processing"], #queue_job_table tr[data-type="waiting"]');b.each(function(b,c){var d=a(c).attr("data-job-id");W.push(d)})}function y(b){X=[],b.each(function(b,c){var d=a(c).attr("data-job-id");X.push(d)});for(var c=!1,d=0;d<=X.length;d++)W[d]!==X[d]&&(c=!0);return c}function z(){Y.log("reorder_jobs");var b=a('#queue_job_table tr[data-type="processing"], #queue_job_table tr[data-type="waiting"]'),c=y(b);c&&b.length>=1?a.ajax({type:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=reorderqueue&sesskey="+U+"&order="+X.toString(),dataType:"json",timeout:3e4,error:function(a,b,c){m("alert",ka),l(),G()},success:function(a){var b={};b=a,console.log(b),b&&b.success===!0?(l(),m("success",la),w(),G()):(l(),m("alert",ka),G())}}):(l(),m("alert",ma),G())}function A(){Y.log("pause_processing"),a.ajax({method:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=pausequeue&enabled=1&sesskey="+U,dataType:"json",timeout:3e4,data:{},error:function(b,c,d){m("alert",na),l(a("#pause_scheduled")),I()},success:function(b){var c={};c=b,console.log(c),c&&c.success===!0?(m("success",oa),l(a("#pause_scheduled")),F()):(m("alert",na),l(a("#pause_scheduled")),I())}})}function B(b,c){Y.log("save_reschedule()"),b.children("p, label, .queue_date_select").css("opacity","0.5"),i(b);var d=b.find('input[value="runnow"]:checked'),e="";e=d.length>=1?Math.floor(Date.now()/1e3):o(b,c),e?a.ajax({method:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=reschedule&sesskey="+U+"&itemid="+c+"&time="+e,dataType:"json",timeout:3e4,data:{},error:function(a,c,d){m("alert",fa),j(b),b.children("p, label, .queue_date_select").css("opacity","1"),I()},success:function(a){var c={};c=a,b.hide(),c&&c.success===!0?(w(),m("success",ga),j(b)):(w(),m("alert",fa),j(b),b.children("p, label, .queue_date_select").css("opacity","1")),I()}}):(m("alert",ja),j(b))}function C(b,c){Y.log("cancel_job"),i(b),a.ajax({method:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=cancelitem&sesskey="+U+"&itemid="+c,dataType:"json",timeout:3e4,data:{},error:function(a,c,d){m("alert",ha),I(),j(b)},success:function(a){var c={};c=a,console.log(c),c&&c.success===!0?(j(b),w(),m("success",ia)):(j(b),m("alert",ha),I())}})}function D(b){a('*[data-reschedule-id="'+b+'"] .queue-date-cancel, *[data-reschedule-id="'+b+'"] .queue-date-save').unbind("click")}function E(b){var c=a('*[data-reschedule-id="'+b+'"] .queue-date-cancel'),d=a('*[data-reschedule-id="'+b+'"] .queue-date-save'),e=a('*[data-reschedule-id="'+b+'"]');c.on("click",function(){e.hide(),D(b),I()}),d.on("click",function(){B(e,b)})}function F(){x(),X=[],a("#queue_job_table").addClass("drag-active"),a("#pause_scheduled").prop("disabled","disabled"),a("#continue_scheduled").removeAttr("disabled").on("click",function(a){a.stopImmediatePropagation(),k(a.currentTarget),z()}),V.sortable("enable")}function G(){a("#queue_job_table").removeClass("drag-active"),a("#continue_scheduled").prop("disabled","disabled"),a("#continue_scheduled").unbind("click"),a("#pause_scheduled").removeAttr("disabled"),V.sortable("disable"),I()}function H(){V=a("#queue_job_table tbody.draggable-parent").sortable({axis:"y",disabled:!0,handle:"i.drag-job",items:"tr.draggable"})}function I(){a("#pause_scheduled").on("click",function(b){b.preventDefault(),b.stopImmediatePropagation(),k(b.currentTarget),J();var c=a('#queue_job_table tr[data-type="processing"], #queue_job_table tr[data-type="waiting"]');c.length>=1&&A()}),a(".reschedule_job").on("click",function(b){b.preventDefault(),J();var c=a(b.currentTarget).attr("data-id");E(c),a('*[data-reschedule-id="'+c+'"]').show()}),a(".cancel_job").on("click",function(b){b.preventDefault(),J();var c=a(b.currentTarget).attr("data-id"),d=a(b.currentTarget).parents(".job-row");C(d,c)})}function J(){a("#pause_scheduled, .cancel_job, .reschedule_job").unbind("click"),a("#pause_scheduled").unbind("click")}function K(){a("#completed_refresh").on("click",function(){N(_,aa,ba)})}function L(){a("#completed_refresh").unbind("click")}function N(b,c,d){Y.log("update_date_objects()");var e=Date.parse(a("#completed_startdate").val()),f=Date.parse(a("#completed_enddate").val());if(isNaN(e))return m("alert",c,a(".local_datahub_completed")),!1;if(isNaN(f))return m("alert",d,a(".local_datahub_completed")),!1;if(f>=e){var g=new Date(e);Z=new Date(g.getUTCFullYear(),g.getUTCMonth(),g.getUTCDate());var h=new Date(f);$=new Date(h.getUTCFullYear(),h.getUTCMonth(),h.getUTCDate(),23,59,59),S(),L()}else m("alert",b,a(".local_datahub_completed"))}function O(a){var b=Date.now(),c=new Date(b);return"min"==a?c.getFullYear()-5+"-"+f(c.getMonth()+1)+"-"+f(c.getDate()):c.getFullYear()+"-"+f(c.getMonth()+1)+"-"+f(c.getDate())}function P(){Y.log("update_date_display");var b=O("max"),c=O("min"),d=Z.getFullYear()+"-"+("0"+String(Z.getMonth()+1)).slice(-2)+"-"+("0"+String(Z.getDate())).slice(-2),e=$.getFullYear()+"-"+("0"+String($.getMonth()+1)).slice(-2)+"-"+("0"+String($.getDate())).slice(-2);a("#completed_startdate").attr("value",d),a("#completed_enddate").attr("value",e),a("#completed_startdate, #completed_enddate").attr("max",b),a("#completed_startdate, #completed_enddate").attr("min",c)}function Q(b,e){if(Y.log("rendercompletequeue"),Z=new Date(1e3*b.start),$=new Date(1e3*b.end),h("completed"),b.data.length<=0){var f={type:"completed"};c.render("local_datahub/nojobs",f).done(function(b){a(".table.completed-jobs .insert-inside").html(b),e.remove(),K(),m("alert",da,a(".local_datahub_completed"))}).fail(d.exception)}else c.render("local_datahub/completejobs",b).done(function(b){e.remove(),K(),a(".table.completed-jobs .insert-inside").html(b),P()}).fail(d.exception)}function R(){console.log("default_completed_range");var a=Date.now();$||($=new Date(a)),Z||(a-=6048e5,Z=new Date(a))}function S(){console.log("refresh_complete");var b=a(".table.completed-jobs .job-row");b.length>=1&&b.hide(),g("completed");var c=String(Math.floor(Z/1e3)),d=String(Math.floor($/1e3));Y.log("startstamp = "+c+" , endstamp = "+d),a.ajax({method:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=getcompleted&sesskey="+U+"&start="+c+"&end="+d,dataType:"json",timeout:3e4,data:{},error:function(c,d,e){h("completed"),b.show(),m("alert",ea,a(".local_datahub_completed"))},success:function(c){var d={};d=c,console.log("refresh_complete, logging object"),console.log(d),d&&d.success===!0?(h("completed"),Q(d,b)):(h("completed"),b.show(),m("alert",ea,a(".local_datahub_completed")))}})}function T(){R(),n(),e(),w(),S(),q()}var U=null,V={},W=[],X=[],Z=null,$=null,_=M.util.get_string("queuedateordererror","local_datahub"),aa=M.util.get_string("queuestartinvaliderror","local_datahub"),ba=M.util.get_string("queueendinvaliderror","local_datahub"),ca=(M.util.get_string("timestampinvaliderror","local_datahub"),M.util.get_string("queuenotimezone","local_datahub")),da=M.util.get_string("queuenojobserror","local_datahub"),ea=M.util.get_string("queuerefresherror","local_datahub"),fa=M.util.get_string("queuerescheduleerror","local_datahub"),ga=M.util.get_string("queuereschedulesuccess","local_datahub"),ha=M.util.get_string("queuecancelerror","local_datahub"),ia=M.util.get_string("queuecancelsuccess","local_datahub"),ja=M.util.get_string("queueinvalidresched","local_datahub"),ka=M.util.get_string("queuedragrescheduleerror","local_datahub"),la=M.util.get_string("queuedragreschedulesuccess","local_datahub"),ma=M.util.get_string("queuedragnochange","local_datahub"),na=M.util.get_string("queuepauseerror","local_datahub"),oa=M.util.get_string("queuepausesuccess","local_datahub");return{init:function(b){U=b,a(document).ready(function(){T()})}}});