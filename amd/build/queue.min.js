define(["jquery","jqueryui","core/templates","core/notification"],function(a,b,c,d){function e(){if(window.Intl&&"object"==typeof window.Intl){var b=Intl.DateTimeFormat().resolvedOptions().timeZone;b&&(ka=M.util.get_string("queuetimezone","local_datahub",b))}a("#timezone_alert p").text(ka)}function f(a){return("0"+String(a)).slice(-2)}function g(b){a(".local_datahub_"+b+" #loading_indicator").addClass("loading")}function h(b){a(".local_datahub_"+b+" #loading_indicator").removeClass("loading")}function i(a){a.find(".reschedule-indicator").addClass("loading")}function j(a){a.find(".reschedule-indicator").removeClass("loading")}function k(){a("#pausecontinue_parent .processing-indicator").addClass("loading")}function l(){a("#pausecontinue_parent .processing-indicator").removeClass("loading")}function m(b){var c=a(".queue_alert, .queue_success");return c.index(b)}function n(b,c,d){if(d||(d=a(".local_datahub_queue")),fa===!0&&(b="alert",fa=!1),ea.length>=1&&(c=ea+c,ea=""),c.length>=1){d.find(".queue_"+b+"_msg").html(c);var e=d.find(".queue_"+b),f=m(e);e.hasClass("show")?(e.removeClass("show"),setTimeout(function(){e.addClass("show")},400)):e.addClass("show"),ga[f]&&clearInterval(ga[f]),ga[f]=setTimeout(function(){e.hasClass("show")&&e.removeClass("show")},3e4)}}function o(b,c){c||(c=a(".local_datahub_queue"));var d=c.find(".queue_"+b);d.hasClass("show")&&d.removeClass("show")}function p(){function b(a,b){return window.getComputedStyle(a,null).getPropertyValue(b)}var c=document.createElement("span");if(c.className="fa",c.style.display="none",document.body.insertBefore(c,document.body.firstChild),"FontAwesome"!==b(c,"font-family")){var d='<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">';a("head").children("script, link").last().after(d)}document.body.removeChild(c)}function q(a){var b=Date.now(),c=a.find("input.reschedule_task").val(),d=Date.parse(c);return!(d<=b||isNaN(d))&&d/1e3}function r(){var b=a('#queue_job_table .job-reschedule-row input[type="radio"]');b.change(function(b){var c=a(b.currentTarget).parents("form").find(".queue_date_select input");a(b.currentTarget).is(":checked")&&"schedule"==a(b.currentTarget).val()?c.prop("disabled",!1):c.prop("disabled",!0)})}function s(){a(".queue_alert button.close, .queue_success button.close").on("click",function(b){b.stopPropagation(),a(b.currentTarget).parents(".alert").removeClass("show")})}function t(a){var b=Date.now(),c=new Date(b),d=c.getFullYear()+"-"+f(c.getMonth()+1)+"-"+f(c.getDate());return a&&(d+="T"+f(c.getHours()+1)+":"+f(c.getMinutes())),d}function u(a){var b=Date.now(),c=new Date(b);return"min"==a?c.getFullYear()+"-"+f(c.getMonth()+1)+"-"+f(c.getDate())+"T00:00":c.getFullYear()+5+"-"+f(c.getMonth()+1)+"-"+f(c.getDate())+"T00:00"}function v(){var b=u("max"),c=u("min");a("input.reschedule_task").attr("max",b),a("input.reschedule_task").attr("min",c),a("input.reschedule_task").attr("value",t(!0))}function w(){Z&&!$&&(a("#pause_scheduled").click(),$=!0)}function x(b,e){var f=b.data.pop();if(Z=!!f.status,a("#pause_scheduled").attr("status",Z),b.data.length<=0){var g={type:"queue"};c.render("local_datahub/nojobs",g).done(function(b){e.remove(),a(".table.jobs .insert-inside").html(b),L(),r(),K(),n("alert",la),w()}).fail(d.exception)}else c.render("local_datahub/queuejobs",b).done(function(b){e.remove(),a(".table.jobs .insert-inside").html(b),L(),r(),K(),n("success",""),v(),w()}).fail(d.exception)}function y(){var b=a(".table.jobs .job-row, .table.jobs .job-reschedule-row");b.length>=1&&b.hide(),g("queue"),a.ajax({method:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=getqueuelist&sesskey="+X,dataType:"json",timeout:3e4,data:{},error:function(a,c,d){Y.log(a+" "+c+" "+d),h("queue"),n("alert",ma),b.show()},success:function(a){var c={};c=a,c&&c.success===!0?(h("queue"),x(c,b)):(h("queue"),b.show(),n("alert",ma))}})}function z(){aa=[];var b=a('#queue_job_table tr[data-type="processing"], #queue_job_table tr[data-type="waiting"]');b.each(function(b,c){var d=a(c).attr("data-job-id");aa.push(d)})}function A(b){ba=[],b.each(function(b,c){var d=a(c).attr("data-job-id");ba.push(d)});for(var c=!1,d=0;d<=ba.length;d++)aa[d]!==ba[d]&&(c=!0);return c}function B(b){b||(b=!1),a.ajax({method:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=pausequeue&enabled=0&sesskey="+X,dataType:"json",timeout:3e4,data:{},error:function(a,c,d){Y.log(a+" "+c+" "+d),b?(ea=ea+xa+"<br>",fa=!0,y()):n("alert",xa),l(),J()},success:function(a){var c={};c=a,c&&c.success===!0?(b?(ea=ea+ya+"<br>",y()):n("success",ya),l(),J()):(b?(ea=ea+xa+"<br>",fa=!0,y()):n("alert",xa),l(),J())}})}function C(){var b=a('#queue_job_table tr[data-type="processing"], #queue_job_table tr[data-type="waiting"]'),c=A(b);c&&b.length>=1?a.ajax({type:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=reorderqueue&sesskey="+X+"&order="+ba.toString(),dataType:"json",timeout:3e4,error:function(a,b,c){Y.log(a+" "+b+" "+c),l(),J(),ea=ea+sa+"<br>",fa=!0,B(!0)},success:function(a){var b={};b=a,b&&b.success===!0?(l(),ea=ea+ta+"<br>",B(!0),J()):(l(),ea=ea+sa+"<br>",fa=!0,B(!0),J())}}):(l(),ea=ea+ua+"<br>",fa=!0,B(!1))}function D(){a.ajax({method:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=pausequeue&enabled=1&sesskey="+X,dataType:"json",timeout:3e4,data:{},error:function(a,b,c){Y.log(a+" "+b+" "+c),n("alert",va),l(),L()},success:function(a){var b={};b=a,b&&b.success===!0?(n("success",wa),l(),I()):(n("alert",va),l(),L())}})}function E(b,c){b.children("p, label, .queue_date_select").css("opacity","0.5"),i(b);var d=b.find('input[value="runnow"]:checked'),e=null;e=d.length>=1?Math.floor(Date.now()/1e3):q(b,c),e?a.ajax({method:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=reschedule&sesskey="+X+"&itemid="+c+"&time="+e,dataType:"json",timeout:3e4,data:{},error:function(a,c,d){Y.log(a+" "+c+" "+d),n("alert",na),j(b),b.children("p, label, .queue_date_select").css("opacity","1"),L()},success:function(a){var c={};c=a,b.hide(),c&&c.success===!0?(y(),n("success",oa),j(b)):(y(),n("alert",na),j(b),b.children("p, label, .queue_date_select").css("opacity","1")),L()}}):(n("alert",ra),j(b))}function F(b,c){i(b),a.ajax({method:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=cancelitem&sesskey="+X+"&itemid="+c,dataType:"json",timeout:3e4,data:{},error:function(a,c,d){Y.log(a+" "+c+" "+d),n("alert",pa),L(),j(b)},success:function(a){var c={};c=a,c&&c.success===!0?(j(b),y(),n("success",qa)):(j(b),n("alert",pa),L())}})}function G(b){a('*[data-reschedule-id="'+b+'"] .queue-date-cancel, *[data-reschedule-id="'+b+'"] .queue-date-save').unbind("click")}function H(b){var c=a('*[data-reschedule-id="'+b+'"] .queue-date-cancel'),d=a('*[data-reschedule-id="'+b+'"] .queue-date-save'),e=a('*[data-reschedule-id="'+b+'"]');c.on("click",function(){e.hide(),G(b),L()}),d.on("click",function(){E(e,b)})}function I(){z(),ba=[],a("#queue_job_table").addClass("drag-active"),a("#pause_scheduled").prop("disabled","disabled"),a("#continue_scheduled").removeAttr("disabled").on("click",function(b){b.stopImmediatePropagation(),k(b.currentTarget),o("alert",a(".local_datahub_queue")),o("success",a(".local_datahub_queue")),C()}),_.sortable("enable")}function J(){a("#queue_job_table").removeClass("drag-active"),a("#continue_scheduled").prop("disabled","disabled"),a("#continue_scheduled").unbind("click"),a("#pause_scheduled").removeAttr("disabled"),_.sortable("disable"),L()}function K(){_=a("#queue_job_table tbody.draggable-parent").sortable({axis:"y",disabled:!0,handle:"i.drag-job",items:"tr.draggable"})}function L(){a("#pause_scheduled").on("click",function(b){b.preventDefault(),b.stopImmediatePropagation(),k(b.currentTarget),o("alert",a(".local_datahub_queue")),o("success",a(".local_datahub_queue")),N(),D()}),a(".reschedule_job").on("click",function(b){b.preventDefault(),o("alert",a(".local_datahub_queue")),o("success",a(".local_datahub_queue")),N();var c=a(b.currentTarget).attr("data-id");H(c),a('*[data-reschedule-id="'+c+'"]').show()}),a(".cancel_job").on("click",function(b){b.preventDefault(),o("alert",a(".local_datahub_queue")),o("success",a(".local_datahub_queue")),N();var c=a(b.currentTarget).attr("data-id"),d=a(b.currentTarget).parents(".job-row");F(d,c)})}function N(){a("#pause_scheduled, .cancel_job, .reschedule_job").unbind("click"),a("#pause_scheduled").unbind("click")}function O(){a("#completed_refresh").on("click",function(){o("alert",a(".local_datahub_completed")),o("success",a(".local_datahub_completed")),Q(ha,ia,ja)})}function P(){a("#completed_refresh").unbind("click")}function Q(b,c,d){var e=Date.parse(a("#completed_startdate").val()),f=Date.parse(a("#completed_enddate").val());if(isNaN(e))return n("alert",c,a(".local_datahub_completed")),!1;if(isNaN(f))return n("alert",d,a(".local_datahub_completed")),!1;if(e<=f){var g=new Date(e);ca=new Date(g.getUTCFullYear(),g.getUTCMonth(),g.getUTCDate());var h=new Date(f);da=new Date(h.getUTCFullYear(),h.getUTCMonth(),h.getUTCDate(),23,59,59),V(),P()}else n("alert",b,a(".local_datahub_completed"))}function R(a){var b=Date.now(),c=new Date(b);return"min"==a?c.getFullYear()-5+"-"+f(c.getMonth()+1)+"-"+f(c.getDate()):c.getFullYear()+"-"+f(c.getMonth()+1)+"-"+f(c.getDate())}function S(){var b=R("max"),c=R("min"),d=ca.getFullYear()+"-"+("0"+String(ca.getMonth()+1)).slice(-2)+"-"+("0"+String(ca.getDate())).slice(-2),e=da.getFullYear()+"-"+("0"+String(da.getMonth()+1)).slice(-2)+"-"+("0"+String(da.getDate())).slice(-2);a("#completed_startdate").attr("value",d),a("#completed_enddate").attr("value",e),a("#completed_startdate, #completed_enddate").attr("max",b),a("#completed_startdate, #completed_enddate").attr("min",c)}function T(b,e){if(ca=new Date(1e3*b.start),da=new Date(1e3*b.end),h("completed"),b.data.length<=0){var f={type:"completed"};c.render("local_datahub/nojobs",f).done(function(b){a(".table.completed-jobs .insert-inside").html(b),e.remove(),O(),n("alert",la,a(".local_datahub_completed")),S()}).fail(d.exception)}else c.render("local_datahub/completejobs",b).done(function(b){e.remove(),O(),a(".table.completed-jobs .insert-inside").html(b),S()}).fail(d.exception)}function U(){var a=Date.now();da||(da=new Date(a)),ca||(a-=6048e5,ca=new Date(a))}function V(){var b=a(".table.completed-jobs .job-row");b.length>=1&&b.hide(),g("completed");var c=String(Math.floor(ca/1e3)),d=String(Math.floor(da/1e3));a.ajax({method:"GET",url:M.cfg.wwwroot+"/local/datahub/importplugins/version2/ajax.php?mode=getcompleted&sesskey="+X+"&start="+c+"&end="+d,dataType:"json",timeout:3e4,data:{},error:function(c,d,e){Y.log(c+" "+d+" "+e),h("completed"),b.show(),n("alert",ma,a(".local_datahub_completed"))},success:function(c){var d={};d=c,d&&d.success===!0?(h("completed"),T(d,b)):(h("completed"),b.show(),n("alert",ma,a(".local_datahub_completed")))}})}function W(){U(),p(),e(),y(),V(),s()}var X=null,Z=0,$=!1,_={},aa=[],ba=[],ca=null,da=null,ea="",fa=!1,ga=[null,null,null,null],ha=M.util.get_string("queuedateordererror","local_datahub"),ia=M.util.get_string("queuestartinvaliderror","local_datahub"),ja=M.util.get_string("queueendinvaliderror","local_datahub"),ka=M.util.get_string("queuenotimezone","local_datahub"),la=M.util.get_string("queuenojobserror","local_datahub"),ma=M.util.get_string("queuerefresherror","local_datahub"),na=M.util.get_string("queuerescheduleerror","local_datahub"),oa=M.util.get_string("queuereschedulesuccess","local_datahub"),pa=M.util.get_string("queuecancelerror","local_datahub"),qa=M.util.get_string("queuecancelsuccess","local_datahub"),ra=M.util.get_string("queueinvalidresched","local_datahub"),sa=M.util.get_string("queuedragrescheduleerror","local_datahub"),ta=M.util.get_string("queuedragreschedulesuccess","local_datahub"),ua=M.util.get_string("queuedragnochange","local_datahub"),va=M.util.get_string("queuepauseerror","local_datahub"),wa=M.util.get_string("queuepausesuccess","local_datahub"),xa=M.util.get_string("queueunpauseerror","local_datahub"),ya=M.util.get_string("queueunpausesuccess","local_datahub");return{init:function(b,c){X=b,Z=c,Y.log("Queue jobs list initialized."),a(document).ready(function(){W()})}}});