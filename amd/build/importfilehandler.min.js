define(["jquery","core/log","core/notification","local_datahub/papaparse"],function(a,b,c,d){function e(){a("#uploadformwrapper #id_version2importfile").change(function(){f();a(this).val();a('input[name="queueschedule"]').removeAttr("disabled")}),a("#uploadformwrapper input#id_queueschedule_0").click(function(){a("#uploadformwrapper select.timeselect").attr("disabled","disabled"),p=!0,g()}),a("#uploadformwrapper input#id_queueschedule_1").click(function(){a("#uploadformwrapper select#id_month").removeAttr("disabled"),p=!1,h()}),a("#uploadformwrapper select#id_month").change(function(){var b=a(this).val();"choose"!=b?(j(b),a("#uploadformwrapper select#id_day").removeAttr("disabled")):a("#uploadformwrapper select#id_day").attr("disabled","disabled")}),a("#uploadformwrapper select#id_day").change(function(){var b=a(this).val(),c=a("#uploadformwrapper select#id_month").val();"choose"!=b?(m(c,b),a("#uploadformwrapper select#id_time").removeAttr("disabled")):a("#uploadformwrapper select#id_time").attr("disabled","disabled")}),a("#uploadformwrapper select#id_time").change(function(){if("choose"!=a(this).val()){var b=a("#uploadformwrapper select#id_month").val().split("_"),c=a("#uploadformwrapper select#id_day").val(),d=a(this).val(),e=new Date;e.setFullYear(b[1]),e.setMonth(b[0]),e.setDate(c),e.setHours(d),e.setMinutes(0),e.setSeconds(0);var f=Math.floor(e.getTime()/1e3);Y.log("utcTimestamp: "+f),a("#uploadformwrapper #queuetimestamp").val(f),p=!0}else a("#uploadformwrapper #queuetimestamp").val(0)});var b=(new Date).toString().match(/([A-Z]+[\+-][0-9]+.*)/)[1];a("#timezoneholder").html(b),setInterval(function(){o&&p?a("#uploadformwrapper #id_submit").removeAttr("disabled"):a("#uploadformwrapper #id_submit").attr("disabled","disabled")},500)}function f(){var b=a("#uploadformwrapper .filepicker-filename a");b=a(b).attr("href"),Y.log("Import file selected: "+b);csv_data=a.ajax({type:"GET",url:b,complete:function(a){Y.log("CSV fetch now complete.");for(var b=a.responseText.split("\n",1),e=d.parse(b[0]),f=e.data[0],g={},h=0;h<f.length;h++){var i=f[h];if(i.indexOf("action")>-1)var j=i.replace("action","");g[i]=1}if(void 0!=j&&void 0!=n[j]){for(var k=!1,l=new Array,h=0;h<n[j].length;h++){var i=n[j][h];0==i.indexOf("*")&&(i=i.replace("*",""),void 0==g[i]&&(k=!0,l.push(i.replace("*",""))))}var m=new Array(M.util.get_string("validationerrorimporttype","dhimport_version2",j));if(k&&m.push(M.util.get_string("validationerrormissingrequired","dhimport_version2",l.join(", "))),k){var p=M.util.get_string("validationerrorheader","dhimport_version2"),q=m.join("<br />");c.alert(p,q)}else o=!0}else{var p=M.util.get_string("validationerrorheader","dhimport_version2"),q=M.util.get_string("validationerrorunknowntype","dhimport_version2");c.alert(p,q)}}})}function g(){a("#uploadformwrapper select.timeselect option:not(:first-child)").remove()}function h(){var b=new Date,c=new Array;c[0]="January",c[1]="February",c[2]="March",c[3]="April",c[4]="May",c[5]="June",c[6]="July",c[7]="August",c[8]="September",c[9]="October",c[10]="November",c[11]="December";for(var d=b.getMonth(),e=b.getFullYear(),f=(new Array,0);f<12;f++){var g='<option value="'+d+"_"+e+'">'+c[d]+" "+e+"</option>";a("#uploadformwrapper select#id_month").append(g),d++,d>11&&(d=0,e++)}}function i(a){var b=new Date,c=b.getMonth(),d=b.getFullYear(),e=c+"_"+d;return e==a}function j(b){var c=new Date,d=b.split("_"),e=parseInt(d[0]),f=parseInt(d[1]);c.setFullYear(f),c.setMonth(e+1),c.setDate(0);var g=c.getDate(),h=1;if(i(b)){var j=new Date;h=j.getDate(),daysInMonth=(new Date).getDate()}a("#uploadformwrapper select#id_day option:not(:first-child)").remove(),a("#uploadformwrapper select#id_time option:not(:first-child)").remove();for(var k=h;k<=g;k++){var l="<option>"+k+"</option>";a("#uploadformwrapper select#id_day").append(l)}}function k(a){var b=new Date;return b.getDate()==a}function l(a){var b=a>=12?"pm":"am";a%=12,a=a?a:12;var c="00",d=a+":"+c+" "+b;return d}function m(b,c){var d=new Date,e=0;i(b)&&k(c)&&(e=d.getHours()+1),a("#uploadformwrapper select#id_time option:not(:first-child)").remove();for(var f=23,g=e;g<=f;g++){var h=l(g),j='<option value="'+g+'">'+h+"</option>";a("#uploadformwrapper select#id_time").append(j)}}var n={},o=!1,p=!0;return{init:function(b){var c=JSON.parse(b),d=0;!function f(){var b=c[d].replace(".csv","");n[b]=new Array,a.ajax({type:"GET",url:"./templates/csv/"+c[d]+"?v=2",dataType:"text",success:function(a){var e=a.split("\n")[0],g=e.split(",");n[b]=g,d++,d<c.length&&f()}})}(),a(document).ready(function(){e()})}}});